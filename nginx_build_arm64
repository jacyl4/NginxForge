#!/bin/bash
set -euo pipefail

trap 'log error "脚本在第 $LINENO 行失败"; exit 1' ERR
umask 022

# ============================================================
# 变量配置
# ============================================================
readonly NGINX_VERSION="1.29.4"
readonly BORINGSSL_REPO="https://github.com/google/boringssl"
readonly ZLIB_REPO="https://github.com/cloudflare/zlib"
readonly BROTLI_REPO="https://github.com/google/ngx_brotli"
readonly ZSTD_REPO="https://github.com/tokers/zstd-nginx-module"
readonly NDK_REPO="https://github.com/vision5/ngx_devel_kit"

readonly PROJECT_DIR="$(pwd)"
readonly BUILD_DIR="$PROJECT_DIR/compile"
readonly OUTPUT_DIR="$PROJECT_DIR/builds/$NGINX_VERSION"

readonly CROSS_PREFIX="aarch64-linux-gnu"
readonly CC="${CROSS_PREFIX}-gcc"
readonly CXX="${CROSS_PREFIX}-g++"
readonly AR="${CROSS_PREFIX}-ar"
readonly RANLIB="${CROSS_PREFIX}-ranlib"
readonly STRIP="${CROSS_PREFIX}-strip"

readonly -a TARGETS=("armv8" "armv8_crc" "armv8_crypto" "armv8.2" "armv8.4" "armv9")

declare -Ar ARCH_CONFIG=(
    ["armv8"]="-march=armv8-a"
    ["armv8_crc"]="-march=armv8-a+crc"
    ["armv8_crypto"]="-march=armv8-a+crc+crypto"
    ["armv8.2"]="-march=armv8.2-a"
    ["armv8.4"]="-march=armv8.4-a"
    ["armv9"]="-march=armv9-a"
)

readonly NGINX_CONFIGURE_ARGS=(
    --prefix=/etc/nginx
    --sbin-path=/usr/sbin/nginx
    --modules-path=/usr/lib/nginx/modules
    --conf-path=/etc/nginx/nginx.conf
    --error-log-path=/var/log/nginx/error.log
    --http-log-path=/var/log/nginx/access.log
    --pid-path=/run/nginx.pid
    --lock-path=/run/nginx.lock
    --http-client-body-temp-path=/var/cache/nginx/client_temp
    --http-proxy-temp-path=/var/cache/nginx/proxy_temp
    --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp
    --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp
    --http-scgi-temp-path=/var/cache/nginx/scgi_temp
    --user=www-data
    --group=www-data
    --with-compat
    --with-file-aio
    --with-threads
    --with-libatomic
    --with-http_ssl_module
    --with-http_v2_module
    --with-http_v3_module
    --with-http_realip_module
    --with-http_addition_module
    --with-http_sub_module
    --with-http_dav_module
    --with-http_flv_module
    --with-http_mp4_module
    --with-http_gunzip_module
    --with-http_gzip_static_module
    --with-http_auth_request_module
    --with-http_random_index_module
    --with-http_secure_link_module
    --with-http_degradation_module
    --with-http_slice_module
    --with-http_stub_status_module
    --with-stream
    --with-stream_ssl_module
    --with-stream_ssl_preread_module
    --with-stream_realip_module
    --with-pcre-jit
)

readonly BASE_CFLAGS="-O3 -pipe -fstack-protector-strong -fPIC -D_FORTIFY_SOURCE=2 -DTCP_FASTOPEN=23"
readonly BASE_LDFLAGS="-Wl,-z,relro,-z,now,--as-needed"

ARCH=""
SKIP_DEPS=0

# ============================================================
# 工具函数
# ============================================================
log() {
    local type=$1; shift
    local GREEN='\033[1;32m' CYAN='\033[1;36m' RED='\033[1;31m'
    local YELLOW='\033[1;33m' MAGENTA='\033[1;35m' RESET='\033[0m'

    [ ! -t 1 ] && { printf '[%s] %s\n' "$(echo "$type" | tr '[:lower:]' '[:upper:]')" "$*"; return; }

    case $type in
        info)    printf "${CYAN}[INFO]${RESET} %s\n" "$*" ;;
        success) printf "${GREEN}[✓]${RESET} %s\n" "$*" ;;
        warn)    printf "${YELLOW}[!]${RESET} %s\n" "$*" ;;
        error)   printf "${RED}[✗]${RESET} %s\n" "$*" >&2 ;;
        build)   printf "${MAGENTA}[BUILD]${RESET} %s\n" "$*" ;;
    esac
}

usage() {
    cat <<'EOF'
Usage: nginx_build_arm64 --arch <target> [options]

Targets: armv8, armv8_crc, armv8_crypto, armv8.2, armv8.4, armv9

Options:
  -a, --arch <target>     Target architecture (required)
      --skip-deps         Skip dependency installation
      --list-targets      List supported targets
  -h, --help              Show this help
EOF
}

parse_arguments() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -a|--arch) ARCH="${2:-}"; shift 2 ;;
            --skip-deps) SKIP_DEPS=1; shift ;;
            --list-targets) printf '%s\n' "${TARGETS[@]}"; exit 0 ;;
            -h|--help) usage; exit 0 ;;
            *) log error "未知参数: $1"; usage; exit 1 ;;
        esac
    done

    [[ -z "$ARCH" ]] && { log error "必须指定 --arch"; usage; exit 1; }
    [[ -z "${ARCH_CONFIG[$ARCH]:-}" ]] && { log error "不支持: $ARCH"; printf '可用: %s\n' "${TARGETS[*]}"; exit 1; }

    for tool in "$CC" "$CXX" "$AR" "$RANLIB" "$STRIP"; do
        command -v "$tool" >/dev/null 2>&1 || { log error "缺少交叉编译工具: $tool"; exit 1; }
    done
}

# ============================================================
# 安装依赖
# ============================================================
install_deps() {
    [[ $SKIP_DEPS -eq 1 ]] && { log info "跳过依赖安装"; return; }

    if command -v apt >/dev/null 2>&1 && [[ $(id -u) -eq 0 ]]; then
        log info "安装依赖..."
        apt update
        DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends \
            ca-certificates wget curl git build-essential cmake \
            libpcre2-dev zlib1g-dev libatomic-ops-dev libbrotli-dev libzstd-dev \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        mkdir -p /etc/nginx/conf.d /var/log/nginx /var/cache/nginx/{client,proxy,fastcgi,uwsgi,scgi}_temp
        log success "依赖安装完成"
    else
        log warn "非 root 或无 apt，跳过依赖安装"
    fi
}

# ============================================================
# 编译流程
# ============================================================
clone_sources() {
    mkdir -p "$BUILD_DIR"
    cd "$BUILD_DIR"

    for repo in boringssl-src:$BORINGSSL_REPO zlib-src:$ZLIB_REPO ngx_brotli:$BROTLI_REPO zstd-nginx-module:$ZSTD_REPO ngx_devel_kit:$NDK_REPO; do
        local dir="${repo%%:*}" url="${repo#*:}"
        [[ -d "$dir/.git" ]] || { rm -rf "$dir"; git clone --depth=1 --recurse-submodules "$url" "$dir"; }
    done

    local version_file="$BUILD_DIR/.nginx-version"
    if [[ ! -d nginx-src ]] || [[ ! -f "$version_file" ]] || [[ "$(cat "$version_file")" != "$NGINX_VERSION" ]]; then
        rm -rf nginx-src
        log info "下载 Nginx $NGINX_VERSION..."
        wget -qO /tmp/nginx.tar.gz "https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz"
        tar -zxf /tmp/nginx.tar.gz -C "$BUILD_DIR"
        mv "nginx-${NGINX_VERSION}" nginx-src
        rm /tmp/nginx.tar.gz
        echo "$NGINX_VERSION" > "$version_file"
    fi

    cd nginx-src
    if [[ ! -f .patched ]]; then
        log info "应用补丁..."
        sed -i 's/CFLAGS="\$CFLAGS -g"/#&/' auto/cc/gcc
        curl -sL https://raw.githubusercontent.com/kn007/patch/master/nginx_dynamic_tls_records.patch | patch -p1 -N 2>/dev/null || true
        curl -sL https://raw.githubusercontent.com/kn007/patch/master/use_openssl_md5_sha1.patch | patch -p1 -N 2>/dev/null || true
        touch .patched
    fi
}

build_boringssl() {
    local name="boringssl-${ARCH}"
    [[ -d "$BUILD_DIR/$name/.openssl" ]] && { log info "BoringSSL 缓存: $ARCH"; return; }

    log build "BoringSSL: $ARCH"
    cd "$BUILD_DIR"
    rm -rf "$name"
    cp -r boringssl-src "$name"
    cd "$name"

    mkdir build && cd build
    cmake -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_SYSTEM_NAME=Linux \
          -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
          -DCMAKE_C_COMPILER="$CC" \
          -DCMAKE_CXX_COMPILER="$CXX" \
          -DCMAKE_C_FLAGS="${BASE_CFLAGS} ${ARCH_CONFIG[$ARCH]}" \
          -DCMAKE_CXX_FLAGS="${BASE_CFLAGS} ${ARCH_CONFIG[$ARCH]}" ..
    make -j "$(nproc)"
    cd ..

    mkdir -p .openssl/{lib,include}
    cp -r include/openssl .openssl/include/
    find build -name 'lib*.a' -exec cp {} .openssl/lib/ \;
    printf '.DEFAULT:\nclean:\ninstall_sw:\n' > .openssl/Makefile
    printf '#!/bin/sh\nexit 0\n' > .openssl/config && chmod +x .openssl/config
    log success "BoringSSL: $ARCH 完成"
}

build_zlib() {
    local name="zlib-${ARCH}"
    [[ -f "$BUILD_DIR/$name/libz.a" ]] && { log info "zlib 缓存: $ARCH"; return; }

    log build "zlib: $ARCH"
    cd "$BUILD_DIR"
    rm -rf "$name"
    cp -r zlib-src "$name"
    cd "$name"

    CFLAGS="${ARCH_CONFIG[$ARCH]} -O3 -fomit-frame-pointer" CC="$CC" AR="$AR" RANLIB="$RANLIB" ./configure >/dev/null 2>&1
    make -j "$(nproc)" libz.a
    log success "zlib: $ARCH 完成"
}

build_nginx() {
    log build "Nginx: $ARCH"
    local build_dir="$BUILD_DIR/nginx-build-${ARCH}"
    local ssl_dir="$BUILD_DIR/boringssl-${ARCH}"
    local zlib_dir="$BUILD_DIR/zlib-${ARCH}"

    rm -rf "$build_dir"
    cp -r "$BUILD_DIR/nginx-src" "$build_dir"
    cd "$build_dir"

    sed -i '/cd \$OPENSSL/,/^$/c\	touch \$OPENSSL/.openssl/include/openssl/ssl.h' auto/lib/openssl/make
    sed -i 's/&& \$(MAKE) distclean//' auto/lib/zlib/make

    local cflags="${ARCH_CONFIG[$ARCH]} ${BASE_CFLAGS} -I${ssl_dir}/.openssl/include"
    local ldflags="${BASE_LDFLAGS} -L${ssl_dir}/.openssl/lib -lstdc++"

    ./configure "${NGINX_CONFIGURE_ARGS[@]}" \
        --with-zlib="$zlib_dir" \
        --add-module="$BUILD_DIR/ngx_brotli" \
        --add-module="$BUILD_DIR/zstd-nginx-module" \
        --add-module="$BUILD_DIR/ngx_devel_kit" \
        --with-openssl="$ssl_dir" \
        --with-cc="$CC" \
        --with-cpp="$CXX" \
        --with-cc-opt="$cflags" \
        --with-ld-opt="$ldflags"

    sed -i 's/-latomic_ops/-latomic_ops -lstdc++/' objs/Makefile
    make -j "$(nproc)"

    "$STRIP" objs/nginx
    mkdir -p "$OUTPUT_DIR"
    cp objs/nginx "$OUTPUT_DIR/nginx-${ARCH}"
    log success "Nginx: $ARCH 完成 ($(ls -lh "$OUTPUT_DIR/nginx-${ARCH}" | awk '{print $5}'))"
}

# ============================================================
# 主流程
# ============================================================
main() {
    parse_arguments "$@"
    log info "编译 Nginx $NGINX_VERSION ($ARCH)"

    mkdir -p "$BUILD_DIR" "$OUTPUT_DIR"
    install_deps
    clone_sources

    build_boringssl &
    build_zlib &
    wait

    build_nginx
    log success "完成！产物: $OUTPUT_DIR/nginx-${ARCH}"
}

start_time=$(date +%s)
main "$@"
log success "耗时 $(($(date +%s) - start_time))s"
