#!/bin/bash

# 版本配置
NGINX_VERSION="1.27.5"
PCRE_VERSION="8.45"
ZLIB_VERSION="1.3.1"
PROJECT_DIR="$(pwd)"
BUILD_DIR="$PROJECT_DIR/compile"
NGINX_SOURCE_DIR="$BUILD_DIR/nginx-${NGINX_VERSION}"

# 彩色输出函数
color() {
    local code=$1; shift
    if [ -t 1 ]; then
        tput setaf "$code"; tput bold; printf "%s\n" "$*"; tput sgr0
    else
        printf "%s\n" "$*"
    fi
}

log() {
    local type=$1; shift
    case $type in
        info)    color 6 "$*" ;;
        success) color 2 "[✓] $*" ;;
        warn)    color 3 "$*" ;;
        error)   color 1 "$*" >&2 ;;
    esac
}

# 创建目录
create_directories() {
    log info "创建必要目录..."
    mkdir -p "$BUILD_DIR"
    mkdir -p /etc/nginx/conf.d /var/log/nginx /var/cache/nginx/{client_temp,proxy_temp,fastcgi_temp,uwsgi_temp,scgi_temp}
    log success "系统目录创建完成"
}

# 安装依赖
install_dependencies() {
    log info "安装系统依赖..."
    apt update && apt install -y --no-install-recommends --no-install-suggests \
        ca-certificates wget curl git build-essential libtool autoconf libssl-dev \
        libperl-dev libpcre3-dev zlib1g-dev libatomic-ops-dev libxslt-dev libbrotli-dev \
        libmimalloc2.0 libmimalloc-dev
}

# PCRE
install_pcre() {
    log info "检查PCRE..."
    cd "$BUILD_DIR"
    if [ -d "pcre-$PCRE_VERSION" ]; then
        log info "PCRE源码已下载，继续编译"
    else
        log info "下载PCRE源码..."
        rm -rf /tmp/pcre.tar.gz "$BUILD_DIR/pcre-*"
        wget --no-check-certificate -qO /tmp/pcre.tar.gz \
            http://ftp.exim.org/pub/pcre/pcre-$PCRE_VERSION.tar.gz
        tar -zxf /tmp/pcre.tar.gz -C "$BUILD_DIR"
    fi
    log info "编译安装PCRE..."
    cd "$BUILD_DIR/pcre-$PCRE_VERSION" || exit 1
    [ ! -f Makefile ] && ./configure
    make -j "$(nproc)" && make install
    cd "$PROJECT_DIR"
    log success "PCRE编译安装完成"
}

# ZLIB
install_zlib() {
    log info "检查ZLIB..."
    cd "$BUILD_DIR"
    local current_zlib_version=$(grep "ZLIB_VERSION" /usr/local/include/zlib.h 2>/dev/null | grep -oP '"\\K[^"]+')
    if [ "$current_zlib_version" = "$ZLIB_VERSION" ]; then
        log success "ZLIB $ZLIB_VERSION 已安装，跳过编译"
        return 0
    fi
    if [ -d "zlib-$ZLIB_VERSION" ]; then
        log info "ZLIB源码已下载，继续编译"
    else
        log info "下载ZLIB源码..."
        rm -rf /tmp/zlib.tar.gz "$BUILD_DIR/zlib-*"
        wget --no-check-certificate -qO /tmp/zlib.tar.gz \
            https://zlib.net/fossils/zlib-$ZLIB_VERSION.tar.gz
        tar -zxf /tmp/zlib.tar.gz -C "$BUILD_DIR"
    fi
    log info "编译安装ZLIB..."
    cd "$BUILD_DIR/zlib-$ZLIB_VERSION" || exit 1
    # 检查 Makefile 是否为占位内容，如果是则重新 configure
    if [ -f Makefile ] && grep -q 'Please use ./configure first' Makefile; then
        log warn "检测到 zlib Makefile 为占位文件，重新 configure..."
        rm -f Makefile
    fi
    if [ ! -f Makefile ]; then
        ./configure --prefix=/usr/local
    fi
    make -j "$(nproc)"
    make install
    cd "$PROJECT_DIR"
    log success "ZLIB编译安装完成"
}

# 克隆模块
clone_modules() {
    log info "检查必要模块..."
    cd "$BUILD_DIR"
    [ -d "ngx_brotli" ] || git clone --depth=1 --recurse-submodules https://github.com/google/ngx_brotli
    [ -d "zstd-nginx-module" ] || git clone --depth=1 --recurse-submodules https://github.com/tokers/zstd-nginx-module
    [ -d "openssl" ] || git clone --depth=1 --recursive https://github.com/quictls/openssl
    [ -d "ngx_devel_kit" ] || git clone --depth=1 https://github.com/vision5/ngx_devel_kit
    cd "$PROJECT_DIR"
    log success "所有模块克隆完成"
}

# 编译nginx
compile_nginx() {
    [ -d "$NGINX_SOURCE_DIR" ] || {
        log info "下载Nginx源码..."
        rm -rf /tmp/nginx.tar.gz "$BUILD_DIR/nginx-*"
        wget --no-check-certificate -qO /tmp/nginx.tar.gz https://nginx.org/download/nginx-$NGINX_VERSION.tar.gz
        tar -zxf /tmp/nginx.tar.gz -C "$BUILD_DIR"
    }
    sed -i 's/CFLAGS="$CFLAGS -g"/#CFLAGS="$CFLAGS -g"/' $NGINX_SOURCE_DIR/auto/cc/gcc
    cd "$NGINX_SOURCE_DIR" || exit 1
    # 应用补丁（如未应用过）
    if ! grep -q "dynamic_tls_records" src/event/ngx_event_openssl.c 2>/dev/null; then
        log info "应用动态TLS记录补丁..."
        curl -s https://raw.githubusercontent.com/kn007/patch/master/nginx_dynamic_tls_records.patch | patch -p01
    fi
    if ! grep -q "use_openssl_md5_sha1" auto/lib/openssl/conf 2>/dev/null; then
        log info "应用OpenSSL MD5/SHA1补丁..."
        curl -s https://raw.githubusercontent.com/kn007/patch/master/use_openssl_md5_sha1.patch | patch -p01
    fi
    ./configure \
      --prefix=/etc/nginx \
      --sbin-path=/usr/sbin/nginx \
      --modules-path=/usr/lib/nginx/modules \
      --conf-path=/etc/nginx/nginx.conf \
      --error-log-path=/var/log/nginx/error.log \
      --http-log-path=/var/log/nginx/access.log \
      --pid-path=/run/nginx.pid \
      --lock-path=/run/nginx.lock \
      --http-client-body-temp-path=/var/cache/nginx/client_temp \
      --http-proxy-temp-path=/var/cache/nginx/proxy_temp \
      --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \
      --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \
      --http-scgi-temp-path=/var/cache/nginx/scgi_temp \
      --user=www-data \
      --group=www-data \
      --with-compat \
      --with-file-aio \
      --with-threads \
      --with-libatomic \
      --with-http_ssl_module \
      --with-http_v2_module \
      --with-http_v3_module \
      --with-http_realip_module \
      --with-http_addition_module \
      --with-http_sub_module \
      --with-http_dav_module \
      --with-http_flv_module \
      --with-http_mp4_module \
      --with-http_gunzip_module \
      --with-http_gzip_static_module \
      --with-http_auth_request_module \
      --with-http_random_index_module \
      --with-http_secure_link_module \
      --with-http_degradation_module \
      --with-http_slice_module \
      --with-http_stub_status_module \
      --with-http_xslt_module=dynamic \
      --with-http_perl_module=dynamic \
      --with-stream \
      --with-stream_ssl_module \
      --with-stream_ssl_preread_module \
      --with-stream_realip_module \
      --with-pcre-jit \
      --with-pcre=$BUILD_DIR/pcre-$PCRE_VERSION \
      --with-zlib=$BUILD_DIR/zlib-$ZLIB_VERSION \
      --add-module=$BUILD_DIR/ngx_brotli \
      --add-module=$BUILD_DIR/ngx_devel_kit \
      --with-openssl=$BUILD_DIR/openssl \
      --with-openssl-opt="enable-ktls enable-ec_nistp_64_gcc_128" \
      --with-cc-opt="-g -O3 -pipe -Wformat -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -DTCP_FASTOPEN=23 -mtune=generic -fPIC" \
      --with-ld-opt="-Wl,-Bsymbolic-functions -flto=auto -ffat-lto-objects -Wl,-z,relro -Wl,-z,now -Wl,-E -Wl,--as-needed -fPIC -L /usr/lib/$(uname -m)-linux-gnu -lmimalloc"
    make -j "$(nproc)"
    cd "$PROJECT_DIR"
    log success "Nginx编译完成"
}

# 复制二进制
copy_nginx_binary() {
    local src="$NGINX_SOURCE_DIR/objs/nginx" tgt="$PROJECT_DIR/nginx"
    if [ -f "$src" ]; then
        cp "$src" "$tgt"
        log success "Nginx二进制文件已复制到: $tgt"
        # 清理编译产物目录
        rm -rf "$BUILD_DIR"
        log success "编译产物已清理，项目目录已保持干净"
    else
        log error "源二进制文件未找到: $src"
    fi
}

main() {
    create_directories
    log info "Nginx版本: $NGINX_VERSION"
    install_dependencies
    install_pcre
    install_zlib
    clone_modules
    compile_nginx
    copy_nginx_binary
    log info "编译过程完成!"
}

main "$@"